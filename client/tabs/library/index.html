<section class="tab-library" data-tab-view="library">
  <header class="library-header">
    <h1>Bibliothèque clinique</h1>
    <p class="muted">
      Importez des PDF, générez un plan de notions via le LLM puis validez
      manuellement les connaissances avant indexation.
    </p>
  </header>

  <section class="library-panel" data-panel="upload">
    <h2>1. Déposer un document</h2>
    <form data-upload-form enctype="multipart/form-data">
      <div class="form-grid">
        <label class="field">
          <span>Fichier PDF</span>
          <input type="file" name="file" accept="application/pdf" required data-upload-file />
        </label>
        <label class="field">
          <span>
            Titre
            <span class="badge badge--provenance" data-provenance-field="title" hidden></span>
          </span>
          <input type="text" name="title" placeholder="Titre du document" />
        </label>
        <label class="field">
          <span>
            Auteur·ices
            <span class="badge badge--provenance" data-provenance-field="authors" hidden></span>
          </span>
          <input type="text" name="authors" placeholder="Nom, Prénom" />
        </label>
        <label class="field">
          <span>
            Année
            <span class="badge badge--provenance" data-provenance-field="year" hidden></span>
          </span>
          <input type="number" name="year" min="1900" max="2100" />
        </label>
        <label class="field">
          <span>
            Type
            <span class="badge badge--provenance" data-provenance-field="type" hidden></span>
          </span>
          <select name="type">
            <option value="Article">Article</option>
            <option value="Guide">Guide</option>
            <option value="Revue systématique">Revue systématique</option>
            <option value="Méta-analyse">Méta-analyse</option>
            <option value="Essai randomisé">Essai randomisé</option>
            <option value="Observationnelle">Étude observationnelle</option>
            <option value="Cas clinique">Cas clinique</option>
            <option value="Qualitatif">Qualitatif</option>
            <option value="Chapitre">Chapitre</option>
            <option value="Rapport">Rapport</option>
            <option value="Site web">Site web</option>
            <option value="Livre">Livre</option>
          </select>
        </label>
        <label class="field">
          <span>
            Domaines
            <span class="badge badge--provenance" data-provenance-field="domains" hidden></span>
          </span>
          <input type="text" name="domains" placeholder="trauma, neurodiversité" />
        </label>
        <label class="field">
          <span>
            Mots-clés
            <span class="badge badge--provenance" data-provenance-field="keywords" hidden></span>
          </span>
          <input type="text" name="keywords" placeholder="masking, validisme" />
        </label>
        <label class="field">
          <span>
            Niveau de preuve
            <span class="badge badge--provenance" data-provenance-field="evidence_level" hidden></span>
          </span>
          <select name="evidence_level">
            <option value="Très élevé">Très élevé</option>
            <option value="Élevé">Élevé</option>
            <option value="Modéré">Modéré</option>
            <option value="Faible">Faible</option>
            <option value="Théorique" selected>Théorique</option>
          </select>
        </label>
      </div>
      <label class="field">
        <span>
          Notes critiques
          <span class="badge badge--provenance" data-provenance-field="notes" hidden></span>
        </span>
        <textarea name="notes" rows="3" placeholder="Remarques sur la qualité méthodologique"></textarea>
      </label>
      <div class="field field-inline">
        <div class="toggle-group" data-toggle-group>
          <label><input type="checkbox" name="autosuggest_pre_default" /> Activer par défaut en Pré‑séance</label>
          <label><input type="checkbox" name="autosuggest_post_default" /> Activer par défaut en Post‑séance</label>
          <span class="badge badge--provenance" data-provenance-field="toggles" hidden></span>
        </div>
        <label class="toggle-single">
          <input type="checkbox" name="pseudonymize" checked />
          Pseudonymiser avant LLM
          <span class="badge badge--provenance" data-provenance-field="pseudonymize" hidden></span>
        </label>
      </div>
      <div class="metadata-tools" data-metadata-tools>
        <button type="button" class="secondary" data-action="show-justifications" disabled>Justifications</button>
        <button type="button" class="secondary" data-action="reextract" disabled>Ré-extraire</button>
        <button type="button" class="secondary" data-action="save-overrides" disabled>Enregistrer les modifications</button>
      </div>
      <div class="actions">
        <button type="submit" class="primary" data-action="upload">Envoyer et extraire</button>
        <span class="status" data-upload-status></span>
      </div>
    </form>
  </section>

  <section class="library-panel" data-panel="status">
    <h2>2. Extraction</h2>
    <div class="status-block" data-extraction-status>
      <p>Aucun traitement en cours.</p>
    </div>
    <div class="actions actions--index">
      <button type="button" class="primary" data-action="index-chunks" disabled>Indexer les chunks</button>
      <span class="status" data-index-status></span>
    </div>
    <div class="chunk-results" data-chunk-results>
      <p class="muted">Aucun chunk indexé pour ce document.</p>
    </div>
  </section>

  <section class="library-panel" data-panel="plan">
    <h2>3. Plan LLM</h2>
    <div class="actions">
      <button type="button" class="secondary" data-action="generate-plan" disabled>Générer le plan</button>
      <label class="checkbox"><input type="checkbox" data-option-keep-clear /> Conserver le prompt clair dans les journaux</label>
    </div>
    <div class="plan-results" data-plan-container></div>
  </section>

  <section class="library-panel" data-panel="review">
    <h2>4. Revue humaine</h2>
    <p class="muted">
      Ajustez les notions proposées, rattachez-les à une notion existante
      ou rejetez celles qui ne sont pas pertinentes.
    </p>
    <div class="review-results" data-review-container></div>
    <div class="actions">
      <button type="button" class="primary" data-action="commit-review" disabled>Indexer la sélection</button>
      <span class="status" data-review-status></span>
    </div>
    <div class="notion-v2" data-notion-panel>
      <h3>Notion canonique</h3>
      <form class="notion-form" data-notion-form>
        <div class="form-grid notion-form__grid">
          <label class="field">
            <span>Identifiant (slug)</span>
            <input type="text" name="notion_id" placeholder="ex. trauma-complexe" required data-notion-id />
          </label>
          <label class="field">
            <span>Étiquette canonique</span>
            <input type="text" name="label" placeholder="Nom de la notion" required data-notion-label />
          </label>
          <label class="field field--full">
            <span>Définition (1–3 phrases testables)</span>
            <textarea name="definition" rows="3" required data-notion-definition></textarea>
          </label>
          <label class="field">
            <span>Synonymes</span>
            <input type="text" name="synonyms" placeholder="synonyme 1, synonyme 2" data-notion-synonyms />
          </label>
          <label class="field">
            <span>Domaines</span>
            <input type="text" name="domains" placeholder="Trauma, Psychotrauma" data-notion-domains />
          </label>
          <label class="field">
            <span>Niveau de preuve</span>
            <select name="evidence_level" data-notion-evidence>
              <option value="élevé">Élevé</option>
              <option value="modéré">Modéré</option>
              <option value="faible">Faible</option>
              <option value="inconnu">Inconnu</option>
            </select>
          </label>
          <label class="field field--full">
            <span>Chunks sources</span>
            <select name="chunk_ids" multiple size="6" data-notion-sources></select>
            <small class="muted">Sélectionnez un ou plusieurs passages soutenant la notion.</small>
          </label>
          <label class="field">
            <span>Citation (ex. « p. 12–17 »)</span>
            <input type="text" name="citation" placeholder="p. 12–17" required data-notion-citation />
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="primary" data-action="save-notion" disabled>Indexer la notion canonique</button>
          <span class="status" data-notion-status></span>
        </div>
      </form>
      <div class="notion-list" data-notion-list>
        <p class="muted">Aucune notion canonique indexée pour ce document.</p>
      </div>
    </div>
  </section>

  <section class="library-panel" data-panel="summary-v2">
    <h2>Ce qui sera utilisable en Pré/Post</h2>
    <ul class="summary-list">
      <li><strong data-summary-chunk-count>0</strong> chunks indexés</li>
      <li><strong data-summary-notion-count>0</strong> notions canoniques</li>
    </ul>
    <p class="muted">Doc&nbsp;ID : <code data-summary-doc-id>—</code></p>
    <p class="muted" data-summary-last-index>Indexer un document pour activer la recherche v2.</p>
    <div class="actions">
      <button type="button" class="secondary" data-action="open-search-debug" disabled>Tester la recherche</button>
    </div>
  </section>

  <section class="library-panel" data-panel="log">
    <h2>Journal</h2>
    <pre data-log-output class="log-output" aria-live="polite"></pre>
  </section>

  <aside class="library-overlay" data-justifications-panel hidden aria-hidden="true">
    <div class="library-overlay__content">
      <header class="library-overlay__header">
        <h3>Justifications du pré-remplissage</h3>
        <button type="button" class="icon-button" data-action="close-justifications" aria-label="Fermer">×</button>
      </header>
      <div class="library-overlay__body" data-justifications-body>
        <p class="muted">Aucune justification disponible.</p>
      </div>
    </div>
  </aside>

  <aside class="library-overlay" data-reextract-panel hidden aria-hidden="true">
    <div class="library-overlay__content">
      <header class="library-overlay__header">
        <h3>Relancer le pré-remplissage</h3>
        <button type="button" class="icon-button" data-action="close-reextract" aria-label="Fermer">×</button>
      </header>
      <form data-reextract-form class="library-overlay__form">
        <p class="muted" data-reextract-empty hidden>Aucun champ surchargé. Vous pouvez relancer pour rafraîchir les propositions.</p>
        <div class="reextract-fields" data-reextract-fields></div>
        <div class="actions">
          <button type="submit" class="primary" data-action="confirm-reextract">Relancer</button>
        </div>
      </form>
    </div>
  </aside>

  <aside class="library-overlay" data-search-modal hidden aria-hidden="true">
    <div class="library-overlay__content">
      <header class="library-overlay__header">
        <h3>Tester la recherche Pré/Post</h3>
        <button type="button" class="icon-button" data-action="close-search-modal" aria-label="Fermer">×</button>
      </header>
      <form class="library-overlay__form" data-search-form>
        <label class="field">
          <span>Requête</span>
          <input type="text" name="query" required data-search-query placeholder="ex. trauma complexe plan personnalisé" />
        </label>
        <div class="form-grid search-form__filters">
          <label class="field">
            <span>Domaines (séparés par des virgules)</span>
            <input type="text" name="domains" data-search-domains placeholder="Trauma, Anxiété" />
          </label>
          <label class="field">
            <span>Année minimale</span>
            <input type="number" name="min_year" min="1900" max="2100" data-search-year />
          </label>
          <label class="field">
            <span>Niveau de preuve minimal</span>
            <select name="min_evidence_level" data-search-evidence>
              <option value="">Aucun</option>
              <option value="faible">Faible</option>
              <option value="modéré">Modéré</option>
              <option value="élevé">Élevé</option>
            </select>
          </label>
        </div>
        <div class="actions">
          <button type="submit" class="primary" data-action="run-search-debug">Rechercher</button>
          <span class="status" data-search-status></span>
        </div>
      </form>
      <div class="search-debug-results" data-search-results>
        <p class="muted">Lancez une recherche pour voir les extraits indexés.</p>
      </div>
    </div>
  </aside>
</section>
